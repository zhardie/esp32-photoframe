name: Build Firmware

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        board: [waveshare_photopainter_73, seeedstudio_xiao_ee02, seeedstudio_reterminal_e1002]
      fail-fast: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Extract version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
        else
          VERSION=$(python3 scripts/get_version.py --type dev)
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Building version: ${VERSION}"
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Build webapp
      run: |
        cd webapp
        npm ci
        npm run build
    
    - name: Setup ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: release-v6.0
        target: esp32s3
        command: |
          idf.py -DSDKCONFIG_DEFAULTS="sdkconfig.defaults;sdkconfig.defaults.${{ matrix.board }}" \
                 -DFIRMWARE_VERSION='${{ steps.version.outputs.version }}' build
    
    - name: Install esptool
      run: pip install esptool

    - name: Prepare & merge firmware artifacts
      run: |
        mkdir -p firmware
        
        # Create merged firmware directly from build directory
        esptool.py --chip esp32s3 merge-bin -o firmware/photoframe-firmware-${{ matrix.board }}-merged.bin \
          --flash-mode dio --flash-freq 80m --flash-size 16MB \
          0x0 build/bootloader/bootloader.bin \
          0x8000 build/partition_table/partition-table.bin \
          0x20000 build/esp32-photoframe.bin

        # Copy OTA binary with board name for release
        cp build/esp32-photoframe.bin firmware/esp32-photoframe-${{ matrix.board }}.bin
    
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: photoframe-firmware-${{ matrix.board }}
        path: firmware/
        retention-days: 90
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        draft: true
        files: |
          firmware/photoframe-firmware-${{ matrix.board }}-merged.bin
          firmware/esp32-photoframe-${{ matrix.board }}.bin
        body: |
          ## ðŸŽ‰ What's New

          ## ðŸ”§ Improvements

          ## Installation
          ### ðŸŒ Web Flasher (Easiest)

          Flash directly from your browser (Chrome/Edge/Opera required):
          **[https://aitjcize.github.io/esp32-photoframe/#flash](https://aitjcize.github.io/esp32-photoframe/)**

          ### ðŸ“¦ Manually
          Choose the appropriate merged binary for your board:
          - `photoframe-firmware-waveshare_photopainter_73-merged.bin`: For Waveshare 7.3" 7-color e-paper
          - `photoframe-firmware-seeedstudio_xiao_ee02-merged.bin`: For Seeed XIAO EE02
          - `photoframe-firmware-seeedstudio_reterminal_e1002-merged.bin`: For Seeed XIAO EE02

          ```bash
          esptool.py --chip esp32s3 --port /dev/ttyUSB0 --baud 921600 write_flash 0x0 photoframe-firmware-[board]-merged.bin
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  deploy-pages:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download all firmware artifacts
      uses: actions/download-artifact@v4
      with:
        path: firmware-artifacts
        pattern: photoframe-firmware-*
        merge-multiple: true
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Build demo webapp
      run: |
        cd webapp
        npm ci
        npm run build:demo
    
    - name: Copy firmware and generate manifests
      run: |
        # Create demo directory if it doesn't exist
        mkdir -p demo

        # Copy sample image for demo page
        cp .img/sample.jpg demo/

        # Get the latest published release tag (not draft)
        # This avoids race conditions when tag push and main push happen simultaneously
        STABLE_TAG=$(gh release view --json tagName -q '.tagName' 2>/dev/null || echo "")
        echo "Latest published release: ${STABLE_TAG:-none}"

        BOARDS="waveshare_photopainter_73 seeedstudio_xiao_ee02 seeedstudio_reterminal_e1002"

        for board in $BOARDS; do
          mkdir -p "demo/$board"

          # Dev firmware from this build
          cp "firmware-artifacts/photoframe-firmware-$board-merged.bin" "demo/$board/photoframe-firmware-$board-dev.bin"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # For releases: use this build as stable
            cp "demo/$board/photoframe-firmware-$board-dev.bin" "demo/$board/photoframe-firmware-$board-merged.bin"
          elif [[ -n "$STABLE_TAG" ]]; then
            # For main branch: download from latest published release using gh (authenticated)
            echo "Downloading stable release ${STABLE_TAG} firmware for $board..."
            if gh release download "$STABLE_TAG" --pattern "photoframe-firmware-$board-merged.bin" --dir "demo/$board" --clobber; then
              echo "Successfully downloaded stable firmware ${STABLE_TAG} for $board"
            elif [[ "$board" == "waveshare_photopainter_73" ]] && gh release download "$STABLE_TAG" --pattern "photoframe-firmware-merged.bin" --dir "demo/$board" --clobber; then
              echo "Successfully downloaded legacy stable firmware for $board"
              mv "demo/$board/photoframe-firmware-merged.bin" "demo/$board/photoframe-firmware-$board-merged.bin"
            else
              echo "Warning: Could not download stable firmware for $board, using dev build as fallback"
              cp "demo/$board/photoframe-firmware-$board-dev.bin" "demo/$board/photoframe-firmware-$board-merged.bin"
            fi
          else
            echo "Warning: No published release found, using dev build as stable for $board"
            cp "demo/$board/photoframe-firmware-$board-dev.bin" "demo/$board/photoframe-firmware-$board-merged.bin"
          fi

          # Generate manifests for this board (pass stable version to match the firmware)
          python3 scripts/generate_manifests.py --no-copy --dev --demo-dir "demo/$board" --board "$board" \
            ${STABLE_TAG:+--stable-version "$STABLE_TAG"}
        done

        # Link a default manifest at the root of demo for backward compatibility or default view
        cp demo/waveshare_photopainter_73/manifest.json demo/
        cp demo/waveshare_photopainter_73/manifest-dev.json demo/
      env:
        GH_TOKEN: ${{ github.token }}
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: demo
    
    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
