name: Build Firmware

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Extract version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Building version: ${VERSION}"
    
    - name: Setup ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: release-v6.0
        target: esp32s3
        command: idf.py -DFIRMWARE_VERSION='${{ steps.version.outputs.version }}' build
    
    - name: Prepare firmware artifacts
      run: |
        mkdir -p firmware
        cp build/photoframe-api.bin firmware/
        cp build/bootloader/bootloader.bin firmware/
        cp build/partition_table/partition-table.bin firmware/
        
        # Create flash_download_tool config
        cat > firmware/download.conf << EOF
        0x0 firmware/bootloader.bin
        0x8000 firmware/partition-table.bin
        0x10000 firmware/photoframe-api.bin
        EOF
        
        # Create esptool flash command
        cat > firmware/FLASH.txt << EOF
        Flash using esptool:
        esptool.py --chip esp32s3 --port /dev/ttyUSB0 --baud 921600 write_flash 0x0 bootloader.bin 0x8000 partition-table.bin 0x10000 photoframe-api.bin
        
        Or use ESP Flash Download Tool with download.conf
        EOF
    
    - name: Install esptool
      run: pip install esptool
    
    - name: Create merged firmware
      run: |
        esptool.py --chip esp32s3 merge_bin -o firmware/photoframe-firmware-merged.bin \
          --flash_mode dio --flash_freq 80m --flash_size 16MB \
          0x0 firmware/bootloader.bin \
          0x8000 firmware/partition-table.bin \
          0x10000 firmware/photoframe-api.bin
    
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: photoframe-firmware
        path: firmware/
        retention-days: 90
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          firmware/photoframe-firmware-merged.bin
          firmware/photoframe-api.bin
          firmware/bootloader.bin
          firmware/partition-table.bin
          firmware/FLASH.txt
        body: |
          ## ðŸŒ Web Flasher (Easiest)
          
          Flash directly from your browser (Chrome/Edge/Opera required):
          **[https://aitjcize.github.io/esp32-photoframe/](https://aitjcize.github.io/esp32-photoframe/)**
          
          ## ðŸ“¦ Firmware Files
          
          **Quick Flash (Recommended):**
          - `photoframe-firmware-merged.bin` - Single file containing bootloader, partition table, and application
            ```bash
            esptool.py --chip esp32s3 --port /dev/ttyUSB0 --baud 921600 write_flash 0x0 photoframe-firmware-merged.bin
            ```
          
          **Individual Files:**
          - `bootloader.bin` - Bootloader (flash at 0x0)
          - `partition-table.bin` - Partition table (flash at 0x8000)
          - `photoframe-api.bin` - Application firmware (flash at 0x10000)
          
          See `FLASH.txt` for detailed flashing instructions.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  deploy-pages:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download firmware artifacts
      uses: actions/download-artifact@v4
      with:
        name: photoframe-firmware
        path: firmware
    
    - name: Copy firmware to docs and generate manifests
      run: |
        # Copy image-processor.js for demo page
        cp process-cli/image-processor.js docs/
        
        # Copy sample image for demo page
        cp .img/sample.jpg docs/
        
        # Get version from tag or use dev version
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
          IS_RELEASE=true
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
          IS_RELEASE=false
        fi
        
        # Handle firmware files based on build type
        if [[ "${IS_RELEASE}" == "true" ]]; then
          # For releases: copy as main firmware
          cp firmware/photoframe-firmware-merged.bin docs/photoframe-firmware-merged.bin
        else
          # For main branch: copy dev firmware with different name
          cp firmware/photoframe-firmware-merged.bin docs/photoframe-firmware-dev.bin
          
          # Download latest stable release firmware from GitHub
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "unknown")
          echo "Downloading stable release ${LATEST_TAG} firmware..."
          
          # Try to download from GitHub releases
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/${LATEST_TAG}/photoframe-firmware-merged.bin"
          if curl -L -f -o docs/photoframe-firmware-merged.bin "${RELEASE_URL}"; then
            echo "Successfully downloaded stable firmware ${LATEST_TAG}"
          else
            echo "Warning: Could not download stable firmware, using dev build as fallback"
            cp firmware/photoframe-firmware-merged.bin docs/photoframe-firmware-merged.bin
          fi
        fi
        
        # Generate manifests based on build type
        if [[ "${IS_RELEASE}" == "true" ]]; then
          # For tagged releases: update manifest.json with release version
          cat > docs/manifest.json << EOF
        {
          "name": "ESP32 PhotoFrame",
          "version": "${VERSION}",
          "home_assistant_domain": "esphome",
          "new_install_prompt_erase": true,
          "new_install_improv_wait_time": 15,
          "builds": [
            {
              "chipFamily": "ESP32-S3",
              "parts": [
                {
                  "path": "photoframe-firmware-merged.bin",
                  "offset": 0
                }
              ]
            }
          ]
        }
        EOF
        else
          # For main branch builds: create both manifests
          # Get latest release tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "unknown")
          
          # Create manifest.json for stable release (points to latest tag)
          cat > docs/manifest.json << EOF
        {
          "name": "ESP32 PhotoFrame",
          "version": "${LATEST_TAG}",
          "home_assistant_domain": "esphome",
          "new_install_prompt_erase": true,
          "new_install_improv_wait_time": 15,
          "builds": [
            {
              "chipFamily": "ESP32-S3",
              "parts": [
                {
                  "path": "photoframe-firmware-merged.bin",
                  "offset": 0
                }
              ]
            }
          ]
        }
        EOF
          
          # Create manifest-dev.json for development build
          cat > docs/manifest-dev.json << EOF
        {
          "name": "ESP32 PhotoFrame (Development)",
          "version": "${VERSION}",
          "home_assistant_domain": "esphome",
          "new_install_prompt_erase": true,
          "new_install_improv_wait_time": 15,
          "builds": [
            {
              "chipFamily": "ESP32-S3",
              "parts": [
                {
                  "path": "photoframe-firmware-dev.bin",
                  "offset": 0
                }
              ]
            }
          ]
        }
        EOF
        fi
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs
    
    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
